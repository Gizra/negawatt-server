<?php
/**
 * @file
 * Code for the Negawatt messages feature.
 */

include_once 'negawatt_message.features.inc';

/**
 * Implements hook_entity_info_alter().
 *
 * Set our own message_access function.
 */
function negawatt_message_entity_info_alter(&$entity_info) {
  $entity_info['message']['access callback'] = 'negawatt_message_message_access';
}

/**
 * Implement custom message_access function to allow messages to be viewed by all users.
 *
 * The notification messages are generated by the normalizer, which runs under
 * The Admin user. In order to allow other users to view the messages, override
 * message-access and set to true for view to all users.
 *
 * @param $op
 *    Operation.
 * @param $entity
 *    Entity to access.
 * @param null $account
 *    User account used.
 * @param string $entity_type
 *    Entity type.
 *
 * @return bool
 *    True if access is granted.
 */
function negawatt_message_message_access($op, $entity, $account = NULL, $entity_type = 'message') {
  if ($op != 'view') {
    return message_access($op, $entity, $account, $entity_type);
  }

  // We count on NegawattMessageAnomalousConsumption::getEntityFieldQuery() to
  // modified the query to retrieve only valid messages (those with og-group-ref
  // compatible with the user's group membership).
  return TRUE;
}
