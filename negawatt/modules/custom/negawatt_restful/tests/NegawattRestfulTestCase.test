<?php

/**
 * @file
 * Contains NegawattNormalizerMeterProcessTestCase
 */

class NegawattRestfulTestCase extends NegawattWebTestCase {

  /**
   * Get test info.
   *
   * @return array
   *    test info
   */
  public static function getInfo() {
    return array(
      'name' => 'Restful API',
      'description' => 'Test the restful API for negawatt-server.',
      'group' => 'Negawatt',
    );
  }

  /**
   * Generate entity value array.
   *
   * @param $value
   *  The value to set for the entity.
   * @param $key
   *  The key, default is 'value'.
   *
   * @return array
   *  An array of array of array for the entity value.
   */
  static function entityValue($value, $key = 'value') {
    return array('und' => array('0' => array($key => $value)));
  }

  /**
   * Prepare accounts, OG-vocabularies, and taxonomy-terms.
   *
   * @throws OgVocabException
   */
  function setUpCategories() {
    // Create two OG account nodes.
    $settings = array(
      'type' => 'account',
      OG_GROUP_FIELD => $this->entityValue(1),
    );
    $account_node1 = $this->drupalCreateNode($settings);

    $settings[OG_GROUP_FIELD] = $this->entityValue(2);
    $account_node2 = $this->drupalCreateNode($settings);

    $this->account_node1 = $account_node1;
    $this->account_node2 = $account_node2;

    // Create several site-categories.

    // Get the vocabulary
    $vocabulary = taxonomy_vocabulary_machine_name_load('site_category');

    // Add school.
    $values = array(
      'vid' => $vocabulary->vid,
      'name' => 'school',
      'vocabulary_machine_name' => $vocabulary->machine_name,
    );
    $term = entity_create('taxonomy_term', $values);
    $wrapper = entity_metadata_wrapper('taxonomy_term', $term);
    $wrapper->field_match_strings->set('בית ספר|בי"ס');
    $wrapper->save();
    // Save term id for late use.
    $this->taxonomy_term_ids['school'] = $term->tid;

    // Add 'lighting'.
    $values['name'] = 'lighting';
    $term = entity_create('taxonomy_term', $values);
    entity_save('taxonomy_term', $term);
    // Save term id for late use.
    $this->taxonomy_term_ids['lighting'] = $term->tid;

    // Add 'street light', mark it as child of 'lighting'.
    $values['name'] = 'street light';
    $values['parent'] = $this->taxonomy_term_ids['lighting'];
    $term = entity_create('taxonomy_term', $values);
    unset($values['parent']);
    $wrapper = entity_metadata_wrapper('taxonomy_term', $term);
    $wrapper->field_match_strings->set('תאורת|מאור');
    $wrapper->save();
    // Save term id for late use.
    $this->taxonomy_term_ids['street light'] = $term->tid;

    // Add 'other'.
    $values['name'] = 'אחר';
    $term = entity_create('taxonomy_term', $values);
    entity_save('taxonomy_term', $term);
    // Save term id for late use.
    $this->taxonomy_term_ids['other'] = $term->tid;

    // Create several meter-categories.

    // Get the vocabulary
    $vocabulary = taxonomy_vocabulary_machine_name_load('meter_category');

    // Add mains.
    $values = array(
      'vid' => $vocabulary->vid,
      'name' => 'mains',
      'vocabulary_machine_name' => $vocabulary->machine_name,
    );
    $term = entity_create('taxonomy_term', $values);
    $wrapper = entity_metadata_wrapper('taxonomy_term', $term);
    $wrapper->field_match_strings->set('ראשי');
    $wrapper->save();
    // Save term id for late use.
    $this->taxonomy_term_ids['mains'] = $term->tid;

    // Add 'other'.
    $values['name'] = 'אחר';
    $term = entity_create('taxonomy_term', $values);
    entity_save('taxonomy_term', $term);
    // Save term id for late use.
    $this->taxonomy_term_ids['other (meter)'] = $term->tid;
  }

  /**
   * Prepare sites for the meters.
   */
  function setUpSites() {

    // # | account | category
    // --+---------+------------
    // 1 |  1      | school
    // 2 |  1      | street-light
    // 3 |  1      | other
    // 4 |  2      | school

    // Create school site.
    // Should be assigned automatically to category 'school'
    $this->siteNode1 = $this->drupalCreateNode(array('type' => 'meter_site'));
    $wrapper = entity_metadata_wrapper('node', $this->siteNode1);
    $wrapper->field_place_address->set('לכיש 25');
    $wrapper->field_place_description->set('בי"ס ויצמן');
    $wrapper->field_place_locality->set('קרית גת');
    $wrapper->OG_AUDIENCE_FIELD->set(1);
    $wrapper->save();

    // Create street light.
    // Should be assigned automatically to category 'street light'
    $this->siteNode2 = $this->drupalCreateNode(array('type' => 'meter_site'));
    $wrapper = entity_metadata_wrapper('node', $this->siteNode2);
    $wrapper->field_place_address->set('צהל 21');
    $wrapper->field_place_description->set('מאור רחובות');
    $wrapper->field_place_locality->set('קרית גת');
    $wrapper->OG_AUDIENCE_FIELD->set(1);
    $wrapper->save();

    // Create other.
    // Should be assigned automatically to category 'other'
    $this->siteNode3 = $this->drupalCreateNode(array('type' => 'meter_site'));
    $wrapper = entity_metadata_wrapper('node', $this->siteNode3);
    $wrapper->field_place_address->set('צהל 21');
    $wrapper->field_place_description->set('תיאור לא ברור');
    $wrapper->field_place_locality->set('קרית גת');
    $wrapper->OG_AUDIENCE_FIELD->set(1);
    $wrapper->save();

    // Create school site for account 2.
    // Should be assigned automatically to category 'school'
    $this->siteNode4 = $this->drupalCreateNode(array('type' => 'meter_site'));
    $wrapper = entity_metadata_wrapper('node', $this->siteNode4);
    $wrapper->field_place_address->set('לכיש 25');
    $wrapper->field_place_description->set('בי"ס ויצמן');
    $wrapper->field_place_locality->set('קרית גת');
    $wrapper->OG_AUDIENCE_FIELD->set(2);
    $wrapper->save();
  }

  /**
   * Prepare sites for the meters.
   */
  function setUpMeters() {

    // # | type   | site             | cat   | account |
    // --+--------+------------------+-------+---------+
    // 1 | modbus | 1 (school)       | mains |  1      |
    // 2 | modbus | 1 (school)       | mains |  1      |
    // 3 | iec    | 1 (school)       | mains |  1      |
    // 4 | iec    | 3 (other)        | other |  1      |
    // 5 | iec    | 2 (street light) | mains |  1      |
    // 6 | iec    | 4 (school)       | mains |  2      |

    // Create modbus meter nodes.
    $settings = array(
      'type' => 'modbus_meter',
      'field_max_frequency' => $this->entityValue(\NegaWattNormalizerTimeManagerInterface::MINUTE),
      'field_meter_site' => $this->entityValue($this->siteNode1->nid, 'target_id'),
      'field_meter_category' => $this->entityValue($this->taxonomy_term_ids['mains'], 'target_id'),
      OG_AUDIENCE_FIELD => $this->entityValue(1, 'target_id'),
    );

    // 2 meters for account 1
    $this->meterNode1 = $this->drupalCreateNode($settings);
    $this->meterNode2 = $this->drupalCreateNode($settings);

    // Create IEC meter nodes.
    // Meter 1 should be assigned automatically to category 'school'
    $settings = array(
      'type' => 'iec_meter',
      'field_max_frequency' => $this->entityValue(\NegaWattNormalizerTimeManagerInterface::MONTH),
      'field_meter_site' => $this->entityValue($this->siteNode1->nid, 'target_id'),
      'field_meter_category' => $this->entityValue($this->taxonomy_term_ids['mains'], 'target_id'),
      OG_AUDIENCE_FIELD => $this->entityValue(1, 'target_id'),
    );

    // More 3 meters for account 1
    $this->meterNode3 = $this->drupalCreateNode($settings);

    // Meter 4 should be assigned to category 'other'.
    $settings['field_meter_site'] = $this->entityValue($this->siteNode3->nid, 'target_id');
    $settings['field_meter_category'] = $this->entityValue($this->taxonomy_term_ids['other (meter)'], 'target_id');
    $this->meterNode4 = $this->drupalCreateNode($settings);

    // Meter 5 should be assigned to category 'street light'.
    $settings['field_meter_site'] = $this->entityValue($this->siteNode2->nid, 'target_id');
    $settings['field_meter_category'] = $this->entityValue($this->taxonomy_term_ids['mains'], 'target_id');
    $this->meterNode5 = $this->drupalCreateNode($settings);

    // Meter 6 for account 2, should be assigned to category 'school'.
    $settings[OG_AUDIENCE_FIELD] = $this->entityValue(2, 'target_id');
    $settings['field_meter_site'] = $this->entityValue($this->siteNode4->nid, 'target_id');
    $this->meterNode6 = $this->drupalCreateNode($settings);
  }

  /**
   * Prepare several messages.
   */
  function setUpMessages() {
    // Create some messages
    $message = message_create('demand_exceeds_cap');
    $wrapper = entity_metadata_wrapper('message', $message);
    $wrapper->field_meter->set($this->meterNode1);
    $wrapper->field_meter_account->set($this->account_node1);
    $wrapper->field_message_place_description->set('first message');
    $wrapper->save();

    $message = message_create('demand_deviate');
    $wrapper = entity_metadata_wrapper('message', $message);
    $wrapper->field_meter->set($this->meterNode6);
    $wrapper->field_meter_account->set($this->account_node2);
    $wrapper->field_message_place_description->set('second message');
    $wrapper->save();
  }

  /**
   * Prepare several messages.
   */
  function setUpElectricity() {

    //  # | meter                  | freq | rate | time          | pwr |
    // ---+------------------------+------+------+---------------+-----+
    //  1 | 1 (modbus, school)     | min  | flat | 12/6/14 15:00 |  2  |
    //  2 | 1 (modbus, school)     | min  | flat | 12/6/14 15:15 |  3  |
    //  3 | 1 (modbus, school)     | min  | flat | 12/6/14 16:00 |  2  |
    //  4 | 1 (modbus, school)     | hour | flat | 12/6/14 15:00 |  2  |
    //  5 | 1 (modbus, school)     | hour | flat | 12/6/14 16:00 |  2  |
    //  6 | 1 (modbus, school)     | day  | flat | 12/6/14 00:00 |  2  |
    //  7 | 2 (modbus, school)     | min  | flat | 12/6/14 15:00 |  4  |
    //  8 | 3 (iec, school)        | min  | flat | 12/6/14 15:00 |  5  |
    //  9 | 4 (iec, other)         | min  | flat | 12/6/14 15:00 |  7  |
    // 10 | 5 (iec, street light)  | min  | flat | 12/6/14 15:00 | 11  |
    // 11 | 6 (iec, school, acc 2) | min  | flat | 12/6/14 15:00 | 13  |

    // Create the normalized electricity data.
    $values_info = array(
      array(
        // Two Modbus entries for hour 15:00.
        'frequency' => \NegaWattNormalizerTimeManagerInterface::MINUTE,
        'timestamp' => strtotime('2014-6-12 15:00'),
        'rate_type' => 'flat',
        'meter_nid' => $this->meterNode1->nid,
        'avg_power' => 2,
        'sum_kwh' => 1440,
        'min_power_factor' => 0.90,
      ),
      array(
        'frequency' => \NegaWattNormalizerTimeManagerInterface::MINUTE,
        'timestamp' => strtotime('2014-6-12 15:15'),
        'rate_type' => 'flat',
        'meter_nid' => $this->meterNode1->nid,
        'avg_power' => 3,
        'sum_kwh' => 2160,
        'min_power_factor' => 0.96,
      ),
      // One entry at 16:00, should not be read when processing 15:00-16:00
      array(
        'frequency' => \NegaWattNormalizerTimeManagerInterface::MINUTE,
        'timestamp' => strtotime('2014-6-12 16:00'),
        'rate_type' => 'flat',
        'meter_nid' => $this->meterNode1->nid,
        'avg_power' => 2,
        'sum_kwh' => 1440,
        'min_power_factor' => 0.96,
      ),
      // Hourly entries
      array(
        'frequency' => \NegaWattNormalizerTimeManagerInterface::HOUR,
        'timestamp' => strtotime('2014-6-12 15:00'),
        'rate_type' => 'flat',
        'meter_nid' => $this->meterNode1->nid,
        'avg_power' => 2,
        'sum_kwh' => 1440,
        'min_power_factor' => 0.96,
      ),
      array(
        'frequency' => \NegaWattNormalizerTimeManagerInterface::HOUR,
        'timestamp' => strtotime('2014-6-12 16:00'),
        'rate_type' => 'flat',
        'meter_nid' => $this->meterNode1->nid,
        'avg_power' => 2,
        'sum_kwh' => 1440,
        'min_power_factor' => 0.96,
      ),
      // Daily entries
      array(
        'frequency' => \NegaWattNormalizerTimeManagerInterface::DAY,
        'timestamp' => strtotime('2014-6-12 00:00'),
        'rate_type' => 'flat',
        'meter_nid' => $this->meterNode1->nid,
        'avg_power' => 2,
        'sum_kwh' => 2000,
        'min_power_factor' => 0.96,
      ),
      // One entry for meter 2, should not be read.
      array(
        'frequency' => \NegaWattNormalizerTimeManagerInterface::MINUTE,
        'timestamp' => strtotime('2014-6-12 15:00'),
        'rate_type' => 'flat',
        'meter_nid' => $this->meterNode2->nid,
        'avg_power' => 4,
        'sum_kwh' => 1440,
        'min_power_factor' => 0.96,
      ),
      // 4 entries for other meters, for category testing.
      array(
        'frequency' => \NegaWattNormalizerTimeManagerInterface::MINUTE,
        'timestamp' => strtotime('2014-6-12 15:00'),
        'rate_type' => 'flat',
        'meter_nid' => $this->meterNode3->nid,
        'avg_power' => 5,
        'sum_kwh' => 1440,
        'min_power_factor' => 0.96,
      ),
      array(
        'frequency' => \NegaWattNormalizerTimeManagerInterface::MINUTE,
        'timestamp' => strtotime('2014-6-12 15:00'),
        'rate_type' => 'flat',
        'meter_nid' => $this->meterNode4->nid,
        'avg_power' => 5,
        'sum_kwh' => 1440,
        'min_power_factor' => 0.96,
      ),
      array(
        'frequency' => \NegaWattNormalizerTimeManagerInterface::MINUTE,
        'timestamp' => strtotime('2014-6-12 15:00'),
        'rate_type' => 'flat',
        'meter_nid' => $this->meterNode5->nid,
        'avg_power' => 5,
        'sum_kwh' => 1440,
        'min_power_factor' => 0.96,
      ),
      array(
        'frequency' => \NegaWattNormalizerTimeManagerInterface::MINUTE,
        'timestamp' => strtotime('2014-6-12 15:00'),
        'rate_type' => 'flat',
        'meter_nid' => $this->meterNode6->nid,
        'avg_power' => 5,
        'sum_kwh' => 1440,
        'min_power_factor' => 0.96,
      ),
    );

    foreach ($values_info as $values) {
      $entity = entity_create('electricity', $values);
      $entity->save();
    }
  }

  /**
   * Setup test environment.
   * Prepare meter nodes and raw data entities.
   */
  function setUp() {
    parent::setUp('negawatt_restful');

    // @fixme
    return;

    $this->setUpCategories();
    $this->setUpSites();
    $this->setUpMeters();
    $this->setUpMessages();
    $this->setUpElectricity();

    // Create a user with access to account 2 only.
    $this->user1 = $this->drupalCreateUser();
    og_group('node', 2, array('entity' => $this->user1));
    // Reload user to get group membership changes.
    $this->user1 = user_load($this->user1->uid, TRUE);

    // Create a user with no access to any account.
    $this->user2 = $this->drupalCreateUser();
  }

  /**
   * Test 'sites' API.
   * - ???.
   */
  function testSitesApi() {

    // @fixme
    return;

    $handler = restful_get_restful_handler('sites');
    $response = $handler->get();

    // There should give 4 sites
    $this->assertTrue(is_array($response) && count($response) == 4, '<b>Testing sites API</b><br>4 sites were found.');
    $site = $response[0];
    $this->assertEqual($site['type'], 'meter_site', 'Site type is correct.');
    $this->assertEqual($site['max_frequency'], 5, 'Max-frequency field is correct.');
    $this->assertEqual($site['meter_id'], 1, 'Meter ID field is correct.');
  }

  /**
   * Test 'meters' API.
   * - Should give both modbus and iec meters.
   * - Max-frequency field should show.
   * - Meter-category field should list the entire category hierarchy.
   * - Particular modbus and iec meters' fields will appear.
   */
  function testMetersApi() {

    // @fixme
    return;

    $handler = restful_get_restful_handler('modbus_meters');
    $response = $handler->get();

    // There should be 2 meters
    $this->assertTrue(is_array($response) && count($response) == 2, 'Two Modbus meters were found.');
    $meter = $response[0];
    $this->assertEqual($meter['type'], 'modbus_meter', 'Meter type is correct.');
    $this->assertEqual($meter['max_frequency'], 5, 'Max-frequency field is correct.');
    $this->assertEqual($meter['meter_id'], 1, 'Meter ID field is correct.');

    $handler = restful_get_restful_handler('iec_meters');
    $response = $handler->get();
    $this->assertTrue(is_array($response) && count($response) == 4, '4 IEC meters were found.');

    // Test meter category.
    $meter = $response[0];
    $tax_id = $this->taxonomy_term_ids['school'];
    $this->assertEqual($meter['meter_categories'][$tax_id]['id'], $tax_id, 'Meter 3 category field (school) is correct.');
    $meter = $response[1];
    $tax_id = $this->taxonomy_term_ids['other'];
    $this->assertEqual($meter['meter_categories'][$tax_id]['id'], $tax_id, 'Meter 4 category field (other) is correct.');
    $meter = $response[2];
    $tax_id = $this->taxonomy_term_ids['street light'];
    $this->assertEqual($meter['meter_categories'][$tax_id]['id'], $tax_id, 'Meter 5 category field (street light) is correct.');
    $meter = $response[3];
    $tax_id = $this->taxonomy_term_ids['street light'];
    $this->assertEqual($meter['meter_categories'][$tax_id]['id'], $tax_id, 'Meter 6 category field (street light) is correct.');

    // Test POST request

    $handler = restful_get_restful_handler('iec_meters');

    // Create a new meter
    $request = array(
      'label' =>'4135364-604-1536093',
      'account' => 2,
      'contract' => 4135364,
      'place_address' => 'דרבן 6',
      'place_description' => '',
      'place_locality' => 'אילת',
      'meter_code' => 604,
      'meter_serial' => 1536093,
      'max_frequency' => 2,
    );
    $result = $handler->post('', $request);
    $id = $result[0]['id'];
    $this->assertEqual($result[0]['label'], '4135364-604-1536093', '<b>Testing POST request</b><br>Meter created successfuly.');
    $this->assertEqual($result[0]['max_frequency'], 2, 'max_frequency field is OK.');

    $request['max_frequency'] = 5;
    $result = $handler->post('', $request);

    $this->assertEqual($result[0]['id'], $id, 'Meter update successful.');
    $this->assertEqual($result[0]['max_frequency'], 5, 'Meter max_frequency was updated.');

    // @todo: Test 'meters' API call
    // @todo: Test that both modbus and iec meters are returned.
  }

  /**
   * Test 'electricity' API.
   * - Should sum values.
   * - Test filter by type.
   * - Test filter by meter-category - should filter values from child categories
   *   as well - e.g. if filtering by category 5 (edu), should show values related
   *   to categories 6 (kindergarten) and 7 (schools).
   */
  function testElectricityApi() {

    // @fixme
    return;

    $handler = restful_get_restful_handler('electricity');
    $response = $handler->get('', array('filter' => array('meter_account' => 1)));

    // There should be 6 entities (due to sum over meters).
    $this->assertTrue(is_array($response) && count($response) == 6, '<b>Testing electricity API</b><br>6 entities were found.');
    $entity = $response[0];
    $this->assertEqual($entity['frequency'], NegaWattNormalizerTimeManagerInterface::DAY, 'Entity 0 is of type DAY.');
    $this->assertEqual($entity['meter'], $this->meterNode1->nid, 'Entity is for meter 1.');
    $this->assertEqual($entity['timestamp'], strtotime('2014-6-12'), 'Entity timestamp is correct.');
    $this->assertEqual($entity['kwh'], 2000, 'Entity kWh is correct.');
    $entity = $response[1];
    $this->assertEqual($entity['frequency'], NegaWattNormalizerTimeManagerInterface::HOUR, 'Entity 1 is of type HOUR.');
    $this->assertEqual($entity['meter'], $this->meterNode1->nid, 'Entity is for meter 1.');
    $this->assertEqual($entity['timestamp'], strtotime('2014-6-12 15:00'), 'Entity timestamp is correct.');
    $entity = $response[2];
    $this->assertEqual($entity['frequency'], NegaWattNormalizerTimeManagerInterface::MINUTE, 'Entity 2 is of type MINUTE.');
    $this->assertEqual($entity['meter'], $this->meterNode1->nid, 'Entity is for meter 1.');
    $this->assertEqual($entity['timestamp'], strtotime('2014-6-12 15:00'), 'Entity timestamp is correct.');
    $this->assertEqual($entity['kwh'], 2880, 'Entity kWh is correct.');
    $this->assertEqual($entity['avg_power'], 3, 'Entity avg-power is correct.');
    $entity = $response[4];
    $this->assertEqual($entity['frequency'], NegaWattNormalizerTimeManagerInterface::HOUR, 'Entity 4 is of type HOUR.');
    $this->assertEqual($entity['meter'], $this->meterNode1->nid, 'Entity is for meter 1.');
    $this->assertEqual($entity['timestamp'], strtotime('2014-6-12 16:00'), 'Entity timestamp is correct.');
    $summary = $handler->getValueMetadata('electricity', 'summary');
    $this->assertEqual($summary['type'], 'category', 'Summary type is correct.');
    $this->assertEqual(count($summary['values']), 1, 'Only one category in summary.');
    $this->assertTrue(!empty($summary['values'][1]), 'Category 1 ("other") in summary.');
    $this->assertEqual($summary['values'][1], 11360, 'Summary value is correct.');
    $this->assertTrue(!empty($summary['timestamp']), 'Timestamp appears in summary.');
    $this->assertEqual($summary['timestamp']['min'], strtotime('2014-6-12 00:00'), 'Min timestamp value is correct.');
    $this->assertEqual($summary['timestamp']['max'], strtotime('2014-6-12 16:00'), 'Max timestamp value is correct.');

    // @todo: Add test for summation of kWh of different meters. For that we
    // need to get the data from a database.

    // Test filter on type=2 (MONTH)
    $response = $handler->get('', array('filter' => array('meter_account' => 1, 'frequency' => 4)));
    // There should be 2 entities.
    $this->assertTrue(is_array($response) && count($response) == 2, '<b>Testing electricity with filter for type=MONTH</b><br>2 entities were found.');
    $entity = $response[0];
    $this->assertEqual($entity['frequency'], NegaWattNormalizerTimeManagerInterface::HOUR, 'Entity 0 is of type HOUR.');
    $this->assertEqual($entity['meter'], $this->meterNode1->nid, 'Entity is for meter 1.');
    $this->assertEqual($entity['timestamp'], strtotime('2014-6-12 15:00'), 'Entity timestamp is correct.');
    $entity = $response[1];
    $this->assertEqual($entity['frequency'], NegaWattNormalizerTimeManagerInterface::HOUR, 'Entity 1 is of type HOUR.');
    $this->assertEqual($entity['meter'], $this->meterNode1->nid, 'Entity is for meter 1.');
    $this->assertEqual($entity['timestamp'], strtotime('2014-6-12 16:00'), 'Entity timestamp is correct.');

    // @todo: Add tests for filter by category.
  }

  /**
   * Test 'message' API.
   * - Test that messages are bounded to user's account permissions.
   */
  function testMessageApi() {

    // @fixme
    return;

    $handler = restful_get_restful_handler('notifications');

    // Test account with access to both groups.
    $response = $handler->get('');

    // There should be 2 entities.
    $this->assertTrue(is_array($response) && count($response) == 2, '<b>Testing messages API</b><br>2 entities were found.');
    $entity = $response[0];
    $this->assertEqual($entity['description'], 'first message', 'Entity 0 place-description is correct.');
    $entity = $response[1];
    $this->assertEqual($entity['description'], 'second message', 'Entity 1 place-description is correct.');

    // Test account filter.
    $response = $handler->get('', array('filter' => array('meter_account' => 2)));
    // There should be 1 entity.
    $this->assertTrue(is_array($response) && count($response) == 1, 'Testing filter by account, only one entity was found.');
    $entity = $response[0];
    $this->assertEqual($entity['description'], 'second message', 'Entity place-description is correct.');

    // Change user to user1, with access to accounts 2 only.
    $handler->setAccount($this->user1);

    // Test that user has access only to second message
    $response = $handler->get('');
    // There should be 1 entity.
    $this->assertTrue(is_array($response) && count($response) == 1, 'Testing user access, only one entity was found.');
    $entity = $response[0];
    $this->assertEqual($entity['description'], 'second message', 'Entity place-description is correct.');

    // Test actual JSON result.
    $formatter_handler = \RestfulManager::outputFormat($handler);
    $json_output = $formatter_handler->format($response);
    $output = json_decode($json_output);
    $this->assertEqual(count($output->data), 1, 'Output array count is correct.');
    $this->assertEqual($output->count, 1, 'Output count is correct.');

    // Test account filter with no access (user has access only to account 2).
    $response = $handler->get('', array('filter' => array('meter_account' => 1)));
    // There should be no entities now.
    $this->assertTrue($response == NULL, 'Testing filter by account with no permission, no entities were found.');

    // Change to user2, no account membership.
    $handler->setAccount($this->user2);

    // Current user is not related to any account, exception will be issued.
    try {
      $response = $handler->get('');
      $this->fail('<b>Testing messages API</b><br>Got exception for user w/o permissions.');
    }
    catch (Exception $e) {
      $this->pass('<b>Testing messages API</b><br>Got exception for user w/o permissions.');
    }
  }
}
