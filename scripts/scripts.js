"use strict";angular.module("negawattClientApp",["angularMoment","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","leaflet-directive","config","LocalStorageModule","ui.router","googlechart","angular-md5","angular-loading-bar","ui.bootstrap.tabs","ui.bootstrap.alert","template/tabs/tab.html","template/tabs/tabset.html","template/alert/alert.html","angularMoment","ui.indeterminate","negawattDirectives"]).config(["$stateProvider","$urlRouterProvider","$httpProvider","cfpLoadingBarProvider",function(a,b,c,d){b.when("","/"),b.when("/",["$injector","$location","$state","Profile",function(a,b,c,d){d.get().then(function(a){a&&c.go("dashboard.withAccount",{accountId:a.account[0].id})})}]),b.otherwise(""),a.state("login",{url:"/login",templateUrl:"views/login.html"}).state("logout",{url:"/logout",template:"<ui-view/>",controller:["Auth","$state",function(a,b){a.logout(),b.go("login")}]}).state("dashboard",{"abstract":!0,url:"/dashboard",templateUrl:"views/dashboard/main.html",resolve:{profile:["Profile",function(a){return a.get()}]},controller:"DashboardCtrl"}).state("dashboard.withAccount",{url:"/{accountId:int}?{chartFreq:int}&{chartNextPeriod:int}&{chartPreviousPeriod:int}",reloadOnSearch:!1,params:{chartFreq:{value:2}},resolve:{account:["$stateParams","Profile","profile",function(a,b,c){return b.selectAccount(a.accountId,c)}],meters:["Meter","account","$stateParams","Category","FilterFactory",function(a,b,c,d,e){return a.get(b.id)}],categories:["Category","account",function(a,b){return a.get(b.id)}],filters:["FilterFactory","categories","$stateParams","meters","account",function(a,b,c,d,e){return a.set("categorized",b),a.set("electricity",c),{loadElectricity:!0,activeElectricityHash:a.get("activeElectricityHash")}}],messages:["Message",function(a){return a.get()}]},views:{"menu@dashboard":{templateUrl:"views/dashboard/main.menu.html",controller:"MenuCtrl"},"map@dashboard":{templateUrl:"views/dashboard/main.map.html",controller:"MapCtrl"},"categories@dashboard":{templateUrl:"views/dashboard/main.categories.html",controller:"CategoryCtrl"},"messages@dashboard":{templateUrl:"views/dashboard/main.messages.html",controller:"MessageCtrl"},"details@dashboard":{templateUrl:"views/dashboard/main.details.html",controller:"DetailsCtrl"},"usage@dashboard":{templateUrl:"views/dashboard/main.usage.html",controller:"UsageCtrl",controllerAs:"chart"}}}).state("dashboard.withAccount.categories",{url:"/category/{categoryId:int}",reloadOnSearch:!1,resolve:{meters:["Meter","$stateParams","account","FilterFactory",function(a,b,c,d){return d.set("category",+b.categoryId),a.get(c.id,b.categoryId)}],categories:["Category","account","categories",function(a,b,c){return a.get(b.id)}],filters:["categories","$stateParams","FilterFactory",function(a,b,c){return{loadElectricity:!0,activeElectricityHash:c.get("activeElectricityHash")}}]},views:{"map@dashboard":{templateUrl:"views/dashboard/main.map.html",controller:"MapCtrl"},"usage@dashboard":{templateUrl:"views/dashboard/main.usage.html",controller:"UsageCtrl",controllerAs:"chart"},"categories@dashboard":{templateUrl:"views/dashboard/main.categories.html",controller:"CategoryCtrl"},"details@dashboard":{templateUrl:"views/dashboard/main.details.html",resolve:{categoriesChart:["ChartCategories","$stateParams","account","categories",function(a,b,c,d){return a.get(c.id,b.categoryId,d.collection)}]},controller:"DetailsCtrl"}}}).state("dashboard.withAccount.markers",{url:"/marker/:markerId?categoryId",reloadOnSearch:!1,resolve:{meters:["Meter","$stateParams","account","FilterFactory",function(a,b,c,d){return d.set("category",+b.categoryId||void 0),d.set("meter",+b.markerId),a.get(c.id,b.categoryId)}],categories:["Category","account","categories",function(a,b,c){return a.get(b.id)}],filters:["meters","$stateParams","FilterFactory",function(a,b,c){return c.set("electricity",b),{loadElectricity:!0,activeElectricityHash:c.get("activeElectricityHash")}}]},views:{"map@dashboard":{templateUrl:"views/dashboard/main.map.html",controller:"MapCtrl"},"categories@dashboard":{templateUrl:"views/dashboard/main.categories.html",controller:"CategoryCtrl"},"details@dashboard":{templateUrl:"views/dashboard/main.details.html",resolve:{categoriesChart:angular.noop},controller:"DetailsCtrl"},"usage@dashboard":{templateUrl:"views/dashboard/main.usage.html",controller:"UsageCtrl",controllerAs:"chart"}}}),c.interceptors.push(["$q","Auth","$location","localStorageService",function(a,b,c,d){return{request:function(a){return a.withoutToken||a.url.match(/.html/)||angular.extend(a.headers,{"access-token":d.get("access_token")}),a},response:function(a){return a.data.access_token&&d.set("access_token",a.data.access_token),a},responseError:function(c){return 401===c.status&&b.authFailed(),a.reject(c)}}}]),d.includeSpinner=!1,d.latencyThreshold=1e3}]).run(["$rootScope","$state","$stateParams","$log","Config","amMoment",function(a,b,c,d,e,f){f.changeLocale("he"),a.$state=b,a.$stateParams=c,e.debugUiRouter&&(a.$on("$stateChangeStart",function(a,b,c,e,f){d.log("$stateChangeStart to "+b.to+"- fired when the transition begins. toState,toParams : \n",b,c)}),a.$on("$stateChangeError",function(a,b,c,e,f){d.log("$stateChangeError - fired when an error occurs during transition."),d.log(arguments)}),a.$on("$stateChangeSuccess",function(a,b,c,e,f){d.log("$stateChangeSuccess to "+b.name+"- fired once the state transition is complete.")}),a.$on("$viewContentLoaded",function(a){d.log("$viewContentLoaded - fired after dom rendered",a)}),a.$on("$stateNotFound",function(a,b,c,e){d.log("$stateNotFound "+b.to+"  - fired when a state cannot be found by its name."),d.log(b,c,e)}))}]),angular.module("negawattClientApp").controller("AccessCtrl",["$window","$scope","$state","Auth","Profile",function(a,b,c,d,e){b.loginButtonEnabled=!0,b.message={},b.login=function(e){b.loginButtonEnabled=!1,d.login(e).then(function(){a.location="#/"},function(a){c.go("login"),b.loginButtonEnabled=!0,a.data?a.data&&401===a.status?b.message.loginFailed=!0:b.message.generalError=a.statusText:b.message.noServerConnection=!0})},b.logout=function(){d.logout(),c.go("login")},b.clear=function(){b.message={}}}]),angular.module("negawattClientApp").controller("DashboardCtrl",["$scope","$timeout","$state","$stateParams","profile","Alerts",function(a,b,c,d,e,f){a.vm={alerts:f},e?!Object.keys(d).length&&c.is("dashboard")&&(vm.defaultAccountId=e.account[0].id,c.go("dashboard.withAccount",{accountId:vm.defaultAccountId})):c.go("login")}]),angular.module("negawattClientApp").controller("UsageCtrl",["$scope","$state","$stateParams","$filter","Electricity","Chart","ChartUsagePeriod","FilterFactory","meters","filters","ChartElectricityUsage",function(a,b,c,d,e,f,g,h,i,j,k){var l=this,m=g.getChartPeriod;l.electricity,angular.isDefined(c.chartFreq)&&f.setActiveFrequency(c.chartFreq),angular.isDefined(c.markerId)&&(a.meterSelected=i.list[c.markerId]),a.$on("nwElectricityChanged",function(a,b){var c;if(!angular.isUndefined(b))return c=d("activeElectricityFilters")(b,"noData"),m().isConfigured()||g.config(d("activeElectricityFilters")(b,"limits")),c&&m().isConfigured()?void k.requestElectricity(g.stateParams):void(l.electricity=d("activeElectricityFilters")(b))}),j.loadElectricity&&e.refresh(j.activeElectricityHash)}]),angular.module("negawattClientApp").controller("MapCtrl",["$scope","$state","$stateParams","$location","Category","Map","leafletData","$timeout","account","meters","FilterFactory",function(a,b,c,d,e,f,g,h,i,j,k){function l(b){h(function(){var c=f.getMarkerSelected();angular.isDefined(c)&&angular.isDefined(a.meters[c])&&a.meters[f.getMarkerSelected()].unselect(),angular.isDefined(a.meters[b])&&(a.meters[b].select(),f.setMarkerSelected(b),m=!0)})}var m=!1;a.defaults=f.getConfig(),a.center=f.getCenter(i),a.meters=j.list,a.$on("leafletDirectiveMarker.mouseover",function(a,b){var d=b.markerName;if(c.openedPopup!==d){c.openedPopup=d;var e=b.leafletEvent.target;e.openPopup()}}),a.$on("leafletDirectiveMarker.mouseout",function(a,b){var d=b.leafletEvent.target;d.closePopup(),c.openedPopup=null}),a.$on("leafletDirectiveMap.dragend",function(){g.getMap().then(function(a){f.setCenter(a.getCenter())})}),a.$on("leafletDirectiveMap.zoomend",function(){g.getMap().then(function(a){f.updateCenterZoom(a.getZoom())})}),a.$on("nwMetersChanged",function(b,c){a.meters=c.list,k.get("meter")&&a.meters[k.get("meter")]&&!m&&l(k.get("meter"))}),a.$on("leafletDirectiveMarker.click",function(a,c){b.forceGo("dashboard.withAccount.markers",{markerId:c.modelName,categoryId:k.get("category"),chartNextPeriod:void 0,chartPreviousPeriod:void 0})}),c.markerId&&(m=l(c.markerId))}]),angular.module("negawattClientApp").controller("CategoryCtrl",["$scope","$state","$stateParams","$filter","Category","Meter","FilterFactory","categories","meters",function(a,b,c,d,e,f,g,h,i){function j(a){g.set("category",a)}a.categories=h,a.accountId=c.accountId,a.chartFreq=c.chartFreq,a.filterMeters=g.showCategoryFilters(),a.hasMeters=function(a){return!!a.meters},a.toggleMetersByCategory=function(b){var c={};c[b.id]=b.checked,g.set("categorized",c),a.$parent.$broadcast("nwMetersChanged",{list:g.byCategoryFilters(i)})},a.select=function(a){g.clearMeterSelection(),b.forceGo("dashboard.withAccount.categories",{categoryId:a,chartNextPeriod:void 0,chartPreviousPeriod:void 0})},a.$on("nwMetersChanged",function(d,f){e.get(c.accountId).then(function(c){b.setGlobal("categories",c),a.categories=c})}),c.categoryId&&j(c.categoryId)}]),angular.module("negawattClientApp").controller("DetailsCtrl",["$scope","$state","$stateParams","FilterFactory","ChartCategories","meters","$filter","categories",function(a,b,c,d,e,f,g,h){function i(b){a.meterSelected=f.list[b]}var j,k;a.categories=h,a.meters=f,a.categoriesChart={},a.onSelect=function(a,d){"category"===k.type&&(j=e.getCategoryIdSelected(a,d),angular.isDefined(j)&&b.go("dashboard.withAccount.categories",{accountId:c.accountId,categoryId:j}))},a.$on("nwMetersChanged",function(b,d){a.meterSelected=d.list[c.markerId],a.metersLoaded=d.loaded}),a.$watch("metersLoaded",function(c){(f.loaded||c)&&angular.isUndefined(a.meterSelected)&&b.is("dashboard.withAccount.markers")&&a.vm.alerts["new"]({type:"default",msg:"מונה לא קיים."})}),a.$on("nwElectricityChanged",function(b,e){if(!angular.isDefined(c.markerId)){var f;k=g("summary")(e[d.get("activeElectricityHash")]),angular.isUndefined(k)||(f="category"===k.type?a.categories.collection:a.meters.listAll,a.categoriesChart=g("toPieChartDataset")(k,f))}}),c.markerId&&i(c.markerId)}]),angular.module("negawattClientApp").controller("MenuCtrl",["$scope","$state","$stateParams","$location","$window","amMoment","Timedate","Category","account","profile","FilterFactory","Meter",function(a,b,c,d,e,f,g,h,i,j,k,l){a.account=i,a.user=j.user,a.timedate=g,a.accountId=c.accountId,a.reloadDashboard=function(){k.clear(),h.reset(),d.url(b.href("dashboard.withAccount").slice(2)),l.refresh()}}]),angular.module("negawattClientApp").controller("MessageCtrl",["$scope","$state","messages",function(a,b,c){a.messages=c}]),angular.module("negawattClientApp").factory("Alerts",["$timeout",function(a){var b=[],c={"new":function(c){b.push(c),a(this.close,3e3,!0,b.length-1)},close:function(a){b.splice(a,1)}};return b=angular.extend(b,c)}]),angular.module("negawattClientApp").service("Auth",["$injector","$rootScope","Utils","localStorageService","Config",function(a,b,c,d,e){this.login=function(b){return a.get("$http")({method:"GET",url:e.backend+"/api/login-token",headers:{Authorization:"Basic "+c.Base64.encode(b.username+":"+b.password)},withoutToken:!0})},this.logout=function(){d.remove("access_token"),b.$broadcast("nwClearCache")},this.isAuthenticated=function(){return!!d.get("access_token")},this.authFailed=function(){a.get("$state").go("login"),this.logout()}}]),angular.module("negawattClientApp").service("Category",["$q","$http","$timeout","$state","$rootScope","$filter","Config","Utils","Meter","FilterFactory",function(a,b,c,d,e,f,g,h,i,j){function k(c){var d=a.defer(),e=g.backend+"/api/meter_categories",f={account:c};return b({method:"GET",url:e,params:f,cache:!0}).success(function(a){d.resolve(a.data)}),d.promise}function l(b,c){var d=a.defer();return b.then(function(a){a=a,a.collection=f("filter")(h.toArray(a.collection),{id:parseInt(c)},!0).pop().children,d.resolve(a)}),d.promise}function m(a){w={data:a,timestamp:new Date},c(function(){w.data=void 0},36e5),e.$broadcast(x)}function n(b,c){var d=a.defer();return i.get(c).then(function(a){v.meters=h.toArray(a.listAll),b.then(o).then(p).then(function(a){m(a),d.resolve(t())})}),d.promise}function o(b){var c,d=a.defer(),e=angular.isArray(b)?b:b.list;return angular.forEach(e,function(a){a.meters=0},e),v.indexed=h.indexById(e),c=v.meters.map(function(a){return a.meter_categories?a.meter_categories:[]}),angular.forEach(c,function(a){angular.forEach(a,function(a){var b=[+a.id];angular.forEach(b,function(a){v.indexed[a].meters++})})}),e=h.toArray(v.indexed),d.resolve(e),d.promise}function p(b){var c=a.defer(),d={};return d.list=b,d.collection=q(b),d.tree=r(b),c.resolve(d),c.promise}function q(a){return h.indexById(a)}function r(a){var b;return a=s(a),b=f("filter")(a,{depth:0})}function s(a){var b=h.indexById(a),c=[];return angular.forEach(a,function(a){angular.forEach(a.children,function(c,d){angular.isString(c)&&(a.children[d]=b[c])}),this.push(a)},c),a}function t(){return angular.isDefined(w.data)&&(w.data.tree=j.refreshCategoriesFilters(w.data.tree)),w.data}var u,v=this,w={},x="nwCategoriesChanged";this.get=function(b,c){return u=a.when(u||t()||k(b)),u=n(u,b),angular.isDefined(c)&&(u=l(u,c)),u["finally"](function(){u=void 0}),u},this.reset=function(){j.set("categorized",t())},e.$on("nwClearCache",function(){w={}})}]),angular.module("negawattClientApp").factory("Chart",["$filter","Utils",function(a,b){function c(){return{1:{frequency:"year",label:"שנה",type:"1",unit_num_seconds:31536e3,chart_default_time_frame:10,chart_type:"ColumnChart",axis_v_title:'קוט"ש בחודש',axis_h_format:"YYYY",axis_h_title:"שנה"},2:{frequency:"month",label:"חודש",type:"2",unit_num_seconds:2678400,chart_default_time_frame:24,chart_type:"ColumnChart",axis_v_title:'קוט"ש בשנה',axis_h_format:"MM-YYYY",axis_h_title:"חודש"},3:{frequency:"day",label:"יום",type:"3",unit_num_seconds:86400,chart_default_time_frame:31,chart_type:"ColumnChart",axis_v_title:'קוט"ש ביום',axis_h_format:"DD-MM",axis_h_title:"תאריך"},4:{frequency:"hour",label:"שעה",type:"4",unit_num_seconds:3600,chart_default_time_frame:168,chart_type:"LineChart",axis_v_title:"KW",axis_h_format:"HH",axis_h_title:"שעה"},5:{frequency:"minute",label:"דקות",type:"5",unit_num_seconds:60,chart_default_time_frame:1440,chart_type:"LineChart",axis_v_title:"KW",axis_h_format:"HH",axis_h_title:"שעה"}}}function d(){angular.forEach(h.frequencies,function(a){a.active=!1})}function e(a){return h[a]||void 0}function f(a){return a.active&&a}var g=angular.isDefined,h={frequencies:c(),multipleGraphs:!1};return{messages:{empty:"אין מספיק נתונים כדי להציג את התרשים."},getFrequencies:function(a){return g(a)?e("frequencies")[a]:e("frequencies")},setActiveFrequency:function(a){d(),h.frequencies[a].active=!0},getActiveFrequency:function(){return a("filter")(b.toArray(h.frequencies),f,!0)[0]}}}]),angular.module("negawattClientApp").factory("ChartOptions",function(){var a=angular.extend,b={isStacked:"true",fill:20,displayExactValues:!0,vAxis:{title:"Set a title vAxis",gridlines:{count:6}},hAxis:{title:"Set a title hAxis"}};return{ColumnChart:a(b,{bar:{groupWidth:"75%"}}),LineChart:b}}),angular.module("negawattClientApp").service("ChartUsagePeriod",["Utils","Period","Chart","moment","$injector","$stateParams","$state",function(a,b,c,d,e,f,g){function h(){var a={chartFreq:+m.chart.type,chartNextPeriod:m.next||void 0,chartPreviousPeriod:m.previous||void 0};k(f,a),g.refreshUrlWith(f)}function i(a){var b={};return"next"===a&&null!==m.next&&(b={next:d.unix(m.next).isAfter(d.unix(m.max),m.chart.frequency)||d.unix(m.next).isSame(d.unix(m.max),m.chart.frequency)?null:m.add(m.next).unix(),previous:m.add(m.previous).unix()}),"previous"===a&&null!==m.previous&&(b={next:m.subtract(m.next).unix(),previous:d.unix(m.previous).isBefore(d.unix(m.min),m.chart.frequency)||d.unix(m.previous).isSame(d.unix(m.min),m.chart.frequency)?null:m.subtract(m.previous).unix()}),b=k(l(m),b)}function j(){angular.extend(m,{max:null,min:null,next:null,previous:null,chart:null})}var k=angular.extend;k(this,c);var l=angular.copy,m=k({},b);this.stateParams=f,this.reset=j,this.config=function(a){m.setLimits(a),m.setTimeFrame(this.getActiveFrequency()),m.setPeriod(),h()},this.getChartPeriod=function(){return m},this.changePeriod=function(a){m.setPeriod(i(a)),h()},this.changeFrequency=function(a){j(),this.setActiveFrequency(a),m.setTimeFrame(this.getActiveFrequency()),h()},this.hasPeriod=function(a){return"next"===a?!i(a).isLast():"previous"===a?!i(a).isFirst():void 0}}]),angular.module("negawattClientApp").service("ChartCategories",["$q","$filter","Utils","Chart",function(a,b,c,d){function e(a,b){var c=g(a,b);return a.type="PieChart",a.data={cols:[{id:"t",label:"Categories",type:"string"},{id:"s",label:"Slices",type:"number"}],rows:f(a,c)},a}function f(a,d){var e=[];return a=b("filter")(c.toArray(a),function(a){return a.meters>0&&a.depth===d?a:void 0}),angular.forEach(a,function(a){this.push({c:[{v:a.label},{v:a.meters},{id:a.id}]})},e),e}function g(a,b){var c=0;return angular.isDefined(b)&&a&&(c=a[0].depth),c}this.get=function(f,g,h){var i=a.defer();return angular.isDefined(g)&&(h=b("filter")(c.toArray(h),{id:parseInt(g)},!0).pop().children),i.resolve(h?e(angular.copy(h),g):d),i.promise},this.getCategoryIdSelected=function(a,b){return b.rows[a.row].c[2].id}}]),angular.module("negawattClientApp").service("Electricity",["$q","$http","$timeout","$rootScope","Config","Utils","FilterFactory",function(a,b,c,d,e,f,g){function h(c,d,f){var k=a.defer(),l=e.backend+"/api/electricity",m=g.getElectricity(c)||{};return d&&(m.page=d),b({method:"GET",url:l,params:m}).success(function(a,b,e,g){var l=angular.isDefined(g.params.nodata),m=void 0!=a.next;i(a,c,f,l),k.resolve(j(c)),m&&!l&&h(c,d+1,!0)}),k.promise}function i(a,b,e,f){l[b]={data:(l[b]?l[b].data:[]).concat(a.data),limits:a.summary.timestamp,timestamp:new Date,noData:f,summary:a.summary},d.$broadcast(o,j()),e||m.push(c(function(){angular.isDefined(l[b])&&(l[b]=void 0)},18e5))}function j(a){return angular.isUndefined(a)?l:l[a]&&l[a].data}var k=this,l={};this.__cache=l;var m=[],n={},o="nwElectricityChanged";this.get=function(b){return angular.isUndefined(b)?void 0:(n[b]=a.when(n[b]||j(b)||h(b,1,!1)),n[b]["finally"](function(){n[b]=void 0}),n[b])},this.refresh=function(a){angular.isUndefined(l[a])&&k.get(a),angular.isDefined(l[a])&&d.$broadcast(o,j())},this.forceResolve=function(a){angular.isUndefined(l[a])&&k.get(a)},d.$on("nwClearCache",function(){l={},angular.forEach(m,function(a){c.cancel(a)}),m=[]})}]),angular.module("negawattClientApp").factory("IconFactory",["$injector","$q",function(a,b){function c(a){return{iconUrl:"../images/markers/"+a,shadowUrl:"../images/shadow.png",iconSize:[40,40],shadowSize:[26,26],iconAnchor:[32,30],shadowAnchor:[25,7],popupAnchor:[-10,-25]}}var d={"default":{unselect:c("marker-blue.png"),select:c("marker-red.png")},createIcons:function(a){angular.forEach(a.list,function(a){angular.isDefined(this[a.icon])||(this[a.icon]={unselect:c(a.icon+"-blue.png"),select:c(a.icon+"-red.png")})},this)},getIcon:function(c,d){var e=this,f=b.defer(),g=a.get("Category");return g.get().then(function(a){e.createIcons(a),f.resolve(e[c][d])}),f.promise}};return d}]),angular.module("negawattClientApp").service("Map",["$rootScope","leafletData",function(a,b){function c(){return b.getMap().then(function(a){var b;b=a.getBounds().pad(1.2),g={northEast:b._northEast,southWest:b._southWest}})}var d=this,e={},f="nwMapChanged",g={};this.getMaxBounds=function(){return g},this.getConfig=function(){return{tileLayer:"https://{s}.tiles.mapbox.com/v3/examples.map-i87786ca/{z}/{x}/{y}.png",zoomControlPosition:"bottomleft",minZoom:12,maxZoom:19,maxNativeZoom:null}},this.setCenter=function(b){e.center=angular.extend(e.center||{},b),a.$broadcast(f)},this.updateCenterZoom=function(a){angular.isDefined(e.center)&&(e.center.zoom=a)},this.getCenter=function(a){return angular.isUndefined(e.center)&&angular.isDefined(a.center)&&d.setCenter(a.center),angular.copy(e.center)},this.centerMapByMarker=function(a){b.getMap().then(function(b){d.setCenter(a.getPosition()),b.setView(d.getCenter())})},this.setMarkerSelected=function(a){e.markerSelected=a},this.getMarkerSelected=function(){return e.markerSelected},a.$on("nwClearCache",function(){e={}}),a.$on("leafletDirectiveMap.load",function(a,b){angular.isDefined(b.model.maxbounds)||(c().then(function(){b.model.maxbounds=d.getMaxBounds()}),a.preventDefault())})}]),angular.module("negawattClientApp").factory("Marker",["$injector","$state","$q","$timeout","Map","IconFactory","FilterFactory",function(a,b,c,d,e,f,g){function h(a,b){var d=f[a]&&f[a][b]||f.getIcon(a,b);return c.when(d)}var i=g.getMeterSelected();return{icon:{},getCategory:function(){var a=Object.keys(this.meter_categories)[0];return a&&this.meter_categories[a].name||"default"},getSelected:function(){return i},unselect:function(){var a=this;h(this.getCategory(),"unselect").then(function(b){a.icon=b})},select:function(){var a=this;angular.isDefined(i)&&i.unselect(),g.setMeterSelected(this),h(this.getCategory(),"select").then(function(b){a.icon=b})},getPosition:function(){return{lat:this.lat,lng:this.lng}}}}]),angular.module("negawattClientApp").service("Meter",["$q","$http","$timeout","$rootScope","$filter","Config","Marker","Utils","FilterFactory",function(a,b,c,d,e,f,g,h,i){function j(c,d){var e,g=a.defer();return d=d||1,e=f.backend+"/api/meters?&filter[account]="+c+"&page="+d,b({method:"GET",url:e,transformResponse:m}).success(function(a){k(a.data,a.hasNextPage),g.resolve(n()),a.hasNextPage&&(r=!0,j(c,o(a.hasNextPage.href))),l()}),g.promise}function k(a,b){var c;angular.isUndefined(q.data)&&(q.data={listAll:{},list:{},summary:{},loaded:!b}),angular.extend(q.data.listAll,a&&a.list),angular.extend(q.data.summary,a&&a.summary),q.timestamp=new Date,d.$broadcast(s,n()),c=e("meterById")(q.data.listAll,i.get("meter")),!h.isEmpty(c)&&c.has_electricity&&d.$broadcast("activeMeter",c),r=!1}function l(){r||c(function(){q.data=void 0},36e5)}function m(a){var b={};return a=angular.fromJson(a),b={data:{list:h.indexById(a.data)},hasNextPage:a.next||!1},angular.forEach(b.data.list,function(a){b.data.list[a.id]=a,a.location&&(b.data.list[a.id].lat=parseFloat(a.location.lat),b.data.list[a.id].lng=parseFloat(a.location.lng),delete a.location),b.data.list[a.id].message=(a.image?'<img src="'+a.image.url+'"><br>':"")+a.place_description+"<br>"+a.place_address+"<br>"+a.place_locality,angular.extend(b.data.list[a.id],g),b.data.list[a.id].unselect()}),b.data.summary=a.summary,b}function n(){return angular.isDefined(q.data)&&(q.data.list=i.byCategoryFilters(q.data),i.isDefine("category")&&(q.data.list=i.byCategory(q.data))),q.data}function o(a){var b=/.*page=([0-9]*)/;return b.exec(a).pop()}var p,q={},r=!1,s="nwMetersChanged";this.get=function(b,c){return p=a.when(p||n()||j(b)),angular.isDefined(c)&&i.set("category",c),p["finally"](function(){p=void 0}),p},this.refresh=function(){d.$broadcast(s,n())},d.$on("nwClearCache",function(){q={}})}]),angular.module("negawattClientApp").factory("FilterFactory",["$filter","$state","$stateParams","$rootScope","$injector","Utils",function(a,b,c,d,e,f){function g(a,b){var c=h(b),d=f.objToHash(c);this.set("activeElectricityHash",d),c=f.cleanProperties(c),this.filters[a]=angular.isUndefined(this.filters[a])?{}:this.filters[a],this.filters[a][this.get("activeElectricityHash")]=c}function h(a){var b={selectorType:"meter",selectorId:a.markerId&&a.markerId.split(","),multipleGraphs:i},c={selectorType:"meter_category",selectorId:a.categoryId,multipleGraphs:i};return angular.extend(a,a.markerId?b:c),j(a)}function i(){return angular.isArray(this.selectorId)}function j(a){var b=e.get("FilterFactory"),c={"filter[meter_account]":a.accountId,"filter[frequency]":a.chartFreq};if(a.chartPreviousPeriod&&a.chartNextPeriod?(angular.extend(c,{"filter[timestamp][operator]":"BETWEEN","filter[timestamp][value][0]":a.chartPreviousPeriod||"","filter[timestamp][value][1]":a.chartNextPeriod||""}),b.set("electricity-nodata",!1)):(angular.extend(c,{nodata:1}),b.set("electricity-nodata",!0)),a.selectorType)if(a.multipleGraphs()){c["filter["+a.selectorType+"][operator]"]="IN";var d=0;angular.forEach(a.selectorId,function(b){c["filter["+a.selectorType+"][value]["+d++ +"]"]=b})}else c["filter["+a.selectorType+"]"]=a.selectorId;return c}function k(a,b){var c=m(b);c=angular.isArray(c)?n(c):p.bind(this,b)(),this.filters[a]=c,l(this.filters[a])}function l(a){a.getCategoryFilter=v,angular.forEach(a,function(a){a.children&&l(a.children)})}function m(a){return a.tree||a}function n(a){return angular.forEach(a,function(b,c){b.children=b.children&&n(b.children),a[c]=o(b)}),a}function o(a){return{id:a.id,label:a.label,children:a.children,checked:!0,indeterminate:!1}}function p(a,b){return angular.isUndefined(b)&&(b=this.get("categorized")),angular.forEach(b,function(c,d){c.id===+Object.keys(a)&&(c.checked=a[c.id],c.children&&r(c.children,a[c.id])),c.children&&(b[d].children=p(a,c.children),"indeterminate"===q(c.children)&&(b[d].checked=!1))},b),b}function q(b){var c;return b=angular.copy(b),angular.isNumber(b[0].meters)&&(b=b.map(function(a){return a.meters=a.meters.toString(),a})),b=a("filter")(b,{meters:"!0"},!0),angular.forEach(b,function(a){c=c!==a.checked&&angular.isDefined(c)||"indeterminate"===c?"indeterminate":a.checked}),c}function r(a,b){angular.forEach(a,function(a,c){a.checked=b,a.children&&r(a.children,b)})}function s(a){var b=t.bind(e.get("FilterFactory"),a)();return b?u(b):!1}function t(a,b){var c;return b=b||this.get("categorized"),angular.forEach(b,function(b){b.id===a&&(c=b.children),b.children&&(c=c||t(a,b.children))}),c}function u(a){var b,c=0;return angular.forEach(a,function(a){a.checked!==b&&(b=a.checked,c++)}),1!==c&&a.length>1?!0:!1}function v(a){var b;return angular.forEach(this,function(c){c.id===a&&(b=c),c.children&&angular.isUndefined(b)&&(b=c.children.getCategoryFilter(a))}),b}function w(a){var b=[],a=a||this.get("categorized");return angular.forEach(a,function(a){a.checked&&b.push(a.id),a.children&&(b=b.concat(w(a.children)))}),b}function x(a,b){return b=b||this,angular.forEach(b,function(c,d){var e,f=a.getCategoryFilter(c.id);angular.isDefined(f)&&(angular.extend(b[d],f,{meters:c.meters,children:c.children}),b[d].indeterminate=s(c.id),c.children&&(e=q(c.children),"indeterminate"!==e&&(b[d].checked=e,b[d].indeterminate=!1))),c.children&&(b[d].children=x(a,c.children))}),b}return{filters:{},byCategory:function(b){return b=f.toArray(b.listAll),f.indexById(a("filter")(b,function(a){return!this.filters.category||a.meter_categories&&a.meter_categories[this.filters.category]?a:void 0}.bind(this),!0))},byCategoryFilters:function(b){return b=f.toArray(b.listAll),b=a("filterMeterByCategories")(b,w.bind(this)(),this.isDefine("categorized"))},showCategoryFilters:function(){var a=!1;return b.is("dashboard.withAccount")&&(a=!0),a},clear:function(){this.clearMeterSelection(),c.chartNextPeriod=void 0,c.chartPreviousPeriod=void 0,this.filters={}},getMeterSelected:function(){return this.filters.meterSelected||void 0},setMeterSelected:function(a){this.filters.meterSelected=a},clearMeterSelection:function(){angular.isDefined(this.filters.meterSelected)&&this.filters.meterSelected.unselect(),this.filters.meterSelected=void 0,this.filters.meter=void 0},refreshCategoriesFilters:function(a){var b=this.get("categorized");return a.$$extendWithFilter=x,b&&a.$$extendWithFilter(b)||a},getElectricity:function(a){return this.filters.electricity&&this.filters.electricity[a]},isDefine:function(a){var b=!!this.filters[a];return angular.isArray(this.filters[a])&&(b=!!this.filters[a].length),b},set:function(a,b){switch(b=angular.copy(b),a){case"categorized":k.bind(this,a,b)();break;case"electricity":g.bind(this,a,b)();break;default:this.filters[a]=b}},get:function(a){return this.filters&&this.filters[a]}}}]),angular.module("negawattClientApp").service("Message",["$q","$http","$rootScope","$state","$timeout","$sce","Config",function(a,b,c,d,e,f,g){function h(){var c=a.defer(),d=g.backend+"/api/anomalous_consumption";return b({method:"GET",url:d,transformResponse:i,cache:!0}).success(function(a){j(a),c.resolve(k.data)}),c.promise}function i(a){var b=angular.fromJson(a).data;return angular.forEach(b,function(a){angular.isDefined(a["long-text"])&&(a["long-text"]=a["long-text"].replace("%23","#"),a["long-text"]=a["long-text"].replace("90","50")),angular.isDefined(a.text)&&(a.text=a.text.replace("90","50"),a.text=a.text.replace("%23","#"))}),b}function j(a){k={data:a,timestamp:new Date},e(function(){k.data=void 0},6e4),c.$broadcast(l)}var k={},l="nwMessagesChanged";this.get=function(){return a.when(k.data||h())},c.$on("nwClearCache",function(){k={}})}]),angular.module("negawattClientApp").service("Profile",["$q","$http","$timeout","$filter","$state","$rootScope","Config",function(a,b,c,d,e,f,g){function h(){var b,c=a.defer();return b=a.all([i(),j()]),b.then(function(a){k(a),c.resolve(n.data)}),c.promise}function i(){var a=g.backend+"/api/me";return b({method:"GET",url:a,transformResponse:l})}function j(){var a=g.backend+"/api/accounts";return b({method:"GET",url:a,transformResponse:m})}function k(a){n={data:{user:a[0].data,account:a[1].data},timestamp:new Date},c(function(){n.data=void 0},36e5),f.$broadcast(o)}function l(a){return angular.fromJson(a).data}function m(a){if(a){var b=angular.fromJson(a);if(b)return angular.forEach(b.data,function(a,b){a.center={lat:parseFloat(a.location.lat),lng:parseFloat(a.location.lng),zoom:parseInt(a.zoom)},delete a.location,delete a.zoom}),b.data}}var n={},o="nwProfileChanged";this.get=function(){return a.when(n.data||h())},this.selectAccount=function(a,b){return a=+a,(angular.isUndefined(b.active)||b.active.id!==a)&&(b.active=d("filter")(b.account,{id:a}).pop(),f.$broadcast("nwClearCache")),b.active},f.$on("nwClearCache",function(){n={}})}]),angular.module("negawattClientApp").factory("Period",["$injector","moment","Utils",function(a,b,c){return{max:null,min:null,next:null,previous:null,chart:null,isConfigured:function(){return!!this.max&&!!this.min},setTimeFrame:function(a){this.chart=a},setLimits:function(a){this.max=a&&+a.max||null,this.min=a&&+a.min||null},setPeriod:function(a){angular.isUndefined(a)&&c.isEmpty(this.next)?this.next=this.max:(this.isOutOfRange(a)&&(this.next=this.max||b().unix()),a.next&&a.previous&&!this.isOutOfRange(a)&&(this.next=a.next)),this.previous=null===this.next?null:this.getPrevious()},getPrevious:function(){return b.unix(this.next).subtract(this.chart&&this.chart.chart_default_time_frame,this.chart&&this.chart.frequency).unix()},isLast:function(){return!this.next},isFirst:function(){return!this.previous},isOutOfRange:function(a){var b=!1;return angular.isUndefined(a)&&(a={next:this.next,previous:this.previous}),a.next||a.previous||(b=!0),a.previous&&a.previous>this.max&&(b=!0),a.next&&a.next<this.min&&(b=!0),b},add:function(a){return b.unix(a).add(this.chart&&this.chart.chart_default_time_frame,this.chart&&this.chart.frequency)},subtract:function(a){return b.unix(a).subtract(this.chart&&this.chart.chart_default_time_frame,this.chart&&this.chart.frequency)}}}]),angular.module("negawattClientApp").service("Utils",["md5",function(a){var b=this;this.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var c,d,e,f,g,h,i,j="",k=0;for(a=b.Base64._utf8_encode(a);k<a.length;)c=a.charCodeAt(k++),d=a.charCodeAt(k++),e=a.charCodeAt(k++),f=c>>2,g=(3&c)<<4|d>>4,h=(15&d)<<2|e>>6,i=63&e,isNaN(d)?h=i=64:isNaN(e)&&(i=64),j=j+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h)+this._keyStr.charAt(i);
return j},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b}},this.indexById=function(a){var b={};return angular.forEach(a,function(a){this[a.id]=a},b),b},this.toArray=function(a){var b=[];return angular.forEach(a,function(a){this.push(a)},b),b},this.objToHash=function(b){return b&&a.createHash(JSON.stringify(b))},this.cleanProperties=function(a){return angular.forEach(a,function(b,c){angular.isUndefined(b)&&delete a[c]}),a},this.isEmpty=function(a){return angular.isUndefined(a)||null===a||angular.isObject(a)&&!Object.keys(a).length}}]),angular.module("negawattClientApp").factory("Timedate",["$interval",function(a){var b={today:new Date,now:null,startClock:function(){var b=this;a(function(){b.now=new Date},1e3)}};return b.startClock(),b}]),angular.module("negawattClientApp").filter("filterMeterByCategories",["Utils","FilterFactory","$filter",function(a,b,c){return function(b,d,e){var f=[];return!d.length&&e&&(b=f),b.length&&d.length&&(angular.isArray(b)||(b=a.toArray(b)),angular.isNumber(d[0])&&(d=d.map(function(a){return a.toString()})),angular.forEach(d,function(a){f=f.concat(c("filter")(b,{meter_categories:{$:{id:a}}},!0))}),b=f),angular.isArray(b)&&(b=a.indexById(b)),b}}]),angular.module("negawattClientApp").filter("meterById",["Utils","FilterFactory","$filter",function(a,b,c){return function(b,c){var d;return d=angular.copy(b)[c]||[],!a.isEmpty(d)&&d||{}}}]),angular.module("negawattClientApp").filter("activeElectricityFilters",["FilterFactory",function(a){function b(a,b){return angular.isUndefined(b)?a.data:a[b]}return function(c,d){var e=a.get("activeElectricityHash");return angular.isDefined(c[e])?b(c[e],d):void 0}}]),angular.module("negawattClientApp").filter("summary",function(){return function(a){return a&&a.summary||void 0}}),angular.module("negawattClientApp").filter("includedByParams",["$state","$stateParams",function(a,b){var c=function(a,c){return angular.isDefined(b[a])&&b[a]&&+b[a]===c};return c}]),angular.module("negawattClientApp").filter("toChartDataset",["Chart","ChartOptions","moment",function(a,b,c){function d(a){return angular.extend(b[a.chart_type],{vAxis:{title:a.axis_v_title},hAxis:{title:a.axis_h_title}})}function e(a){var b={cols:[{id:"month",label:"Month",type:"string"},{id:"flat",label:"אחיד",type:"number"},{id:"peak",label:"פסגה",type:"number"},{id:"mid",label:"גבע",type:"number"},{id:"low",label:"שפל",type:"number"}],rows:f(a,"single")};return b}function f(a,b){var d,e,f={},h=[];return"single"===b&&(e="LineChart"===g.chart_type,angular.forEach(a,function(a){a.timestamp in f||(f[a.timestamp]={}),f[a.timestamp][a.rate_type]=+a.kwh,e&&d&&d!=a.rate_type&&(f[a.timestamp][d]=+a.kwh),d=a.rate_type}),angular.forEach(f,function(a,b){var d=c.unix(b).format(g.axis_h_format),e=[{v:d},{v:a.flat},{v:a.peak},{v:a.mid},{v:a.low}];h.push({c:e})})),h}var g;return function(b){return g=a.getActiveFrequency(),b={type:g.chart_type,data:e(b),options:d(g)}}}]),angular.module("negawattClientApp").filter("toPieChartDataset",["Utils","$filter",function(a,b){function c(a){return{title:"Kws per "+a,pieSliceText:"label"}}function d(a,b){var c={cols:[{id:"t",label:a.type,type:"string"},{id:"s",label:"Kws",type:"number"}],rows:e(a.values,a.type,b)};return c}function e(b,c,d){var e=[];switch(c){case"category":angular.forEach(b,function(b,c){this.push({c:[{v:!a.isEmpty(d)&&d[c].label||"category "+c},{v:+b},{id:c}]})},e);break;case"meter":angular.forEach(b,function(b,c){this.push({c:[{v:!a.isEmpty(d)&&d[c].contract||"meter "+c},{v:+b},{id:c}]})},e)}return e}return function(a,b){return a={type:"PieChart",data:d(a,b),options:c(a.type)}}}]),angular.module("negawattClientApp").directive("loadingBarText",function(){return{restrict:"EA",template:'<div class="splash-screen" ng-show="isLoading">{{text}}</div>',controller:["$scope",function(a){function b(b){a.isLoading=b}a.text="טוען...",a.isLoading=!1,a.$on("cfpLoadingBar:started",function(){b(!0)}),a.$on("cfpLoadingBar:completed",function(){b(!1)})}],scope:{}}}),angular.module("negawattDirectives",[]).directive("chartElectricityUsage",function(){return{restrict:"EA",templateUrl:"scripts/directives/chart-electricity-usage.directive.html",controller:["ChartElectricityUsage","Utils","ChartUsagePeriod","FilterFactory","Electricity","$state","$stateParams","$timeout","$urlRouter","$location","$filter","$scope",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(a){return angular.isDefined(a)?void(t.state=a):void(t.state=o()?"data":"empty")}function n(){return!angular.isUndefined(t.state)}function o(){return t.data.data.rows.length||!1}function p(a){return n()&&o()?c.hasPeriod(a):!1}function q(b){n()&&(c.changePeriod(b),a.requestElectricity(c.stateParams))}function r(b){n()&&(c.changeFrequency(b),a.requestElectricity(c.stateParams))}function s(a){t.data=k("toChartDataset")(a),m()}var t=this;t.frequencies=c.getFrequencies(),t.state="loading",t.showNavigation=p,t.changePeriod=q,t.hasData=o,t.changeFrequency=r,t.messages={empty:c.messages.empty},l.$watch("ctrlChart.electricity",function(a){angular.isUndefined(a)||s(a)},!0)}],controllerAs:"ctrlChart",bindToController:!0,scope:{electricity:"="}}}),angular.module("negawattClientApp").service("ChartElectricityUsage",["FilterFactory","Electricity",function(a,b){function c(c){a.set("electricity",c),b.refresh(a.get("activeElectricityHash"))}this.requestElectricity=c}]),angular.module("negawattClientApp").config(["$provide",function(a){a.decorator("$state",["$delegate","$urlRouter","$location","$stateParams","Utils",function(a,b,c,d,e){var f=(angular.copy,angular.extend),g=(angular.isDefined,angular.isUndefined),h={};return a.go=function(b,c,d){return g(h[b])&&(h[b]={reloadOnSearch:a.$current.reloadOnSearch}),a.$current.reloadOnSearch=h[b].reloadOnSearch,a.transitionTo(b,c,f({inherit:!0,relative:a.$current},d))},a.forceGo=function(b,c,d){return a.current.reloadOnSearch=!0,a.transitionTo(b,c,f({inherit:!0,relative:a.$current},d))},a.setGlobal=function(b,c){if(!angular.isUndefined(a.$current.locals.globals[b])){var d=a.$current.locals;angular.forEach(d,function(a,d){"resolve"!==d&&(a[b]=c)})}},a.refreshUrlWith=function(e){angular.forEach(d,function(a,b){null===a&&delete d[b]}),c.url(b.href(a.$current.url,d).slice(1)),b.sync()},a}])}]);